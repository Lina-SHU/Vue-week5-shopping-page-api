<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>購物網站</title>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css"
    integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
  <script src="https://unpkg.com/vue@next"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue-loading-overlay@4.0.3/dist/vue-loading.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vue-loading-overlay@4.0.3/dist/vue-loading.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
  <div id="app">
    <div class="container">
      <!---商品列表-->
      <div class="row d-flex justify-content-center">
        <div class="col-md-10">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">商品圖片</th>
                <th scope="col">商品名稱</th>
                <th scope="col">商品售價</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="product in productList" :key="product.id">
                <td width="25%">
                  <div class="productImg" style="height: 120px; object-fit:cover; background-position: center center;"
                    :style="{'background-image': `url(${product.imageUrl})` }"></div>
                </td>
                <td>{{ product.title }}</td>
                <td>{{ product.price }}</td>
                <td>
                  <button type="button" class="btn btn-outline-secondary" @click="openModal(product.id)">查看更多</button>
                  <button type="button" class="btn btn-primary" @click="addCart(product.id)">加入購物車</button>
                </td>
              </tr>
            </tbody>
          </table>
          <pagination :pagination="pagination" @get-product="getProduct"></pagination>
        </div>
      </div>

      <!---購物車列表-->
      <button class="btn btn-outline-dark" @click="deleteCarts" v-if="cartList.length > 1">刪除所有購物車商品</button>
      <h3 class="text-center mt-5">購物車清單</h3>
      <table class="table mt-3">
        <thead>
          <tr>
            <th scope="col"></th>
            <th scope="col">商品圖片</th>
            <th scope="col">商品名稱</th>
            <th scope="col">商品數量</th>
            <th scope="col">商品金額</th>
          </tr>
        </thead>
        <tbody>
          <template v-if="cartList.length !==0">
            <tr v-for="item in cartList" :key="item.id" class="border-bottom">
              <td class="align-middle text-center"><i class="fas fa-times text-danger fa-1x"
                  @click="deleteCartItem(item.id)" style="cursor: pointer;"></i></td>
              <td>
                <div style="height: 120px; object-fit:cover; background-position: center center;"
                  :style="{'background-image': `url(${item.product.imageUrl})`}"></div>
              </td>
              <td>{{ item.product.title }}</td>
              <td width="20%">
                <input type="number" min="1" class="form-control" v-model.number="item.qty" @change="editCart(item)">
              </td>
              <td>{{ item.product.price * item.qty }}</td>
            </tr>
          </template>
        </tbody>
      </table>

      <!---填寫購買人資訊-->
      <valid-form :cart-list="cartList" @get-cart="getCart"></valid-form>

    </div>
    <loading :active="isLoading"></loading>
    <detail-product ref="detailModal" :product="tempProduct" @add-cart="addCart"></detail-product>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vee-validate/4.1.17/vee-validate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vee-validate/i18n@4.1.17/dist/vee-validate-i18n.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vee-validate/rules@4.1.17/dist/vee-validate-rules.min.js"></script>


  <script type="module">
    import detailProduct from './js/detailProduct.js';
    import validForm from './js/validForm.js';
    import pagination from './js/pagination.js';

    // 加入規則
    VeeValidate.defineRule('email', VeeValidateRules['email']);
    VeeValidate.defineRule('required', VeeValidateRules['required']);
    // 加入多國語系
    VeeValidateI18n.loadLocaleFromURL('./zh_TW.json');

    // Activate the locale
    VeeValidate.configure({
      generateMessage: VeeValidateI18n.localize('zh_TW'),
      validateOnInput: true, // 調整為輸入字元立即進行驗證
    });

    const apiUrl = 'https://vue3-course-api.hexschool.io/';
    const path = 'linachen';

    const app = Vue.createApp({
      data() {
        return {
          productList: {
            "imagesUrl": []
          },
          tempProduct: {},
          cartList: [],
          pagination: {},
          isLoading: true
        }
      },
      components: {
        detailProduct,
        validForm,
        pagination
      },
      methods: {
        getProduct(page = 1) {
          // 取得商品列表
          const url = `${apiUrl}api/${path}/products?page=${page}`;
          axios.get(url)
            .then(res => {
              if (res.data.success) {
                this.productList = res.data.products;
                this.pagination = res.data.pagination;
              } else {
                alert('商品取得失敗');
              }
            })
            .catch(err => {
              console.log(err);
            })
        },
        openModal(id) {
          // 取得單一商品
          const url = `${apiUrl}api/${path}/product/${id}`;
          axios.get(url)
            .then(res => {
              if (res.data.success) {
                this.tempProduct = res.data.product;
              } else {
                alert('商品取得失敗');
              }
            })
            .catch(err => {
              console.log(err);
            })
          this.$refs.detailModal.openModal();
        },
        addCart(id, qty = 1) {
          // 加入購物車
          const url = `${apiUrl}api/${path}/cart`;
          axios.post(url, { data: { "product_id": id, "qty": qty } })
            .then(res => {
              if (res.data.success) {
                alert('成功加入購物車');
                this.$refs.detailModal.hideModal();
                this.getCart();
              } else {
                alert('加入購物車失敗');
              }
            })
            .catch(err => {
              console.log(err);
            })
        },
        getCart() {
          // 取得購物車列表
          const url = `${apiUrl}api/${path}/cart`;
          axios.get(url)
            .then(res => {
              if (res.data.success) {
                this.cartList = res.data.data.carts;
              } else {
                alert('取得購物車失敗');
              }
            })
            .catch(err => {
              console.log(err);
            })
        },
        editCart(item) {
          // 更新購物車數量
          const url = `${apiUrl}api/${path}/cart/${item.id}`;
          axios.put(url, { "data": { "product_id": item.product.id, "qty": item.qty } })
            .then(res => {
              if (res.data.success) {
                this.getCart();
              } else {
                alert('更新購物車失敗');
              }
            })
            .catch(err => {
              console.log(err);
            })
        },
        deleteCarts() {
          // 刪除所有購物車商品
          const url = `${apiUrl}api/${path}/carts`;
          axios.delete(url)
            .then(res => {
              if (res.data.success) {
                alert('刪除購物車所有商品成功');
                this.getCart();
              } else {
                alert('刪除購物車所有商品失敗');
              }
            })
            .catch(err => {
              console.log(err);
            })
        },
        deleteCartItem(id) {
          // 刪除購物車單一商品
          const url = `${apiUrl}api/${path}/cart/${id}`;
          axios.delete(url)
            .then(res => {
              if (res.data.success) {
                alert('刪除購物車商品成功');
                this.getCart();
              } else {
                alert('刪除購物車商品失敗');
              }
            })
            .catch(err => {
              console.log(err);
            })
        }
      },
      mounted() {
        this.getProduct();
        this.getCart();
        setTimeout(() => {
          this.isLoading = false;
        }, 2000)
      }
    });

    app.component('VForm', VeeValidate.Form);
    app.component('VField', VeeValidate.Field);
    app.component('ErrorMessage', VeeValidate.ErrorMessage);
    console.log(VueLoading);
    app.component('loading', VueLoading);
    app.mount('#app');
  </script>
</body>

</html>